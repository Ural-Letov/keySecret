{% extends "base.html" %}

{% block title %}–ö–æ—à–µ–ª—å–∫–∏ - keySecret{% endblock %}

{% block content %}
<div class="wallets-page">
    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-wallet"></i>
            –ü–æ–∏—Å–∫ –∫–æ—à–µ–ª—å–∫–æ–≤
        </h1>
        <p class="page-subtitle">–ù–∞–π–¥–∏—Ç–µ –∏ —É–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–≤–æ–∏–º–∏ –∫–æ—à–µ–ª—å–∫–∞–º–∏</p>
    </div>

    <div class="search-section">
        <div class="search-card">
            <form id="searchForm" class="search-form">
                <div class="form-group">
                    <label for="name_filter">
                        <i class="fas fa-search"></i>
                        –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞ (–ø–æ–∏—Å–∫)
                    </label>
                    <input type="text" id="name_filter" name="name_filter" 
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞...">
                </div>

                <div class="form-group">
                    <label for="master_key">
                        <i class="fas fa-key"></i>
                        –ü–æ–ª–Ω—ã–π –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á –¥–ª—è –¥–µ—à–∏—Ñ—Ä–æ–≤–∫–∏
                    </label>
                    <input type="text" id="master_key" name="master_key" 
                           value="{{ session.master_key }}" required>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i>
                        –ü–æ–∏—Å–∫ / –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                    <a href="{{ url_for('create_wallet') }}" class="btn btn-success">
                        <i class="fas fa-plus"></i>
                        –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π
                    </a>
                </div>
            </form>
        </div>
    </div>

    <div class="results-section">
        <div class="results-header">
            <h3>
                <i class="fas fa-list"></i>
                –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
            </h3>
        </div>

        <div id="walletsResults" class="wallets-results">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i>
                <span>–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('searchForm').addEventListener('submit', function(e) {
    e.preventDefault();
    searchWallets();
});

function searchWallets() {
    const formData = new FormData(document.getElementById('searchForm'));
    const resultsDiv = document.getElementById('walletsResults');
    
    resultsDiv.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i><span>–ü–æ–∏—Å–∫...</span></div>';
    
    fetch('{{ url_for("search_wallets_api") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        displayWallets(data);
    })
    .catch(error => {
        resultsDiv.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∫–æ—à–µ–ª—å–∫–æ–≤</div>';
    });
}

function displayWallets(wallets) {
    const resultsDiv = document.getElementById('walletsResults');
    
    if (wallets.length === 0) {
        resultsDiv.innerHTML = '<div class="no-results">üîç –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
        return;
    }
    
    let html = '';
    wallets.forEach(wallet => {
        if (wallet.decrypted) {
            html += `
                <div class="wallet-card">
                    <div class="wallet-header">
                        <h4><i class="fas fa-wallet"></i> ${wallet.name}</h4>
                        <span class="status success"><i class="fas fa-unlock"></i> –î–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ</span>
                    </div>
                    <div class="wallet-details">
                        <div class="detail-row">
                            <span class="label"><i class="fas fa-user"></i> –õ–æ–≥–∏–Ω:</span>
                            <span class="value">${wallet.login}</span>
                        </div>
                        <div class="detail-row">
                            <span class="label"><i class="fas fa-lock"></i> –ü–∞—Ä–æ–ª—å:</span>
                            <span class="value password-field" data-password="${wallet.password}">
                                <span class="password-text">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                                <button class="btn btn-small" onclick="togglePassword(this)">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="label"><i class="fas fa-globe"></i> –•–æ—Å—Ç:</span>
                            <span class="value">${wallet.host}</span>
                        </div>
                    </div>
                    <div class="wallet-actions">
                        <button class="btn btn-primary btn-small" onclick="copyPassword('${wallet.password}')">
                            <i class="fas fa-copy"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å
                        </button>
                    </div>
                </div>
            `;
        } else {
            html += `
                <div class="wallet-card">
                    <div class="wallet-header">
                        <h4><i class="fas fa-wallet"></i> *** (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ)</h4>
                        <span class="status error"><i class="fas fa-lock"></i> –ù–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ</span>
                    </div>
                    <div class="wallet-details">
                        <div class="detail-row">
                            <span class="label"><i class="fas fa-user"></i> –õ–æ–≥–∏–Ω:</span>
                            <span class="value">***</span>
                        </div>
                        <div class="detail-row">
                            <span class="label"><i class="fas fa-lock"></i> –ü–∞—Ä–æ–ª—å:</span>
                            <span class="value">***</span>
                        </div>
                        <div class="detail-row">
                            <span class="label"><i class="fas fa-globe"></i> –•–æ—Å—Ç:</span>
                            <span class="value">***</span>
                        </div>
                    </div>
                    <div class="wallet-note">
                        <i class="fas fa-exclamation-triangle"></i>
                        –ù–µ–≤–µ—Ä–Ω—ã–π –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á –¥–ª—è –¥–µ—à–∏—Ñ—Ä–æ–≤–∫–∏
                    </div>
                </div>
            `;
        }
    });
    
    resultsDiv.innerHTML = html;
}

function togglePassword(button) {
    const passwordField = button.closest('.password-field');
    const passwordText = passwordField.querySelector('.password-text');
    const icon = button.querySelector('i');
    const password = passwordField.dataset.password;
    
    if (passwordText.textContent === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
        passwordText.textContent = password;
        icon.className = 'fas fa-eye-slash';
    } else {
        passwordText.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
        icon.className = 'fas fa-eye';
    }
}

function copyPassword(password) {
    navigator.clipboard.writeText(password).then(() => {
        alert('üìã –ü–∞—Ä–æ–ª—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
    }).catch(() => {
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø–∞—Ä–æ–ª—è');
    });
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—à–µ–ª—å–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    searchWallets();
});
</script>
{% endblock %}
